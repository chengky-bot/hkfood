<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¦™æ¸¯å°å­¸å ‚ - è¶£å‘³å­¸ç¿’éŠæˆ²</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    
    <!-- Lucide Icons (Vanilla JS version) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FFF8E7;
            overflow-x: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .holographic-btn {
            background: linear-gradient(135deg, rgba(255,105,180,0.6), rgba(100,149,237,0.6), rgba(255,215,0,0.6));
            background-size: 200% 200%;
            animation: holographic 3s ease infinite;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        @keyframes holographic {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- Lucide Icon Component ---
        const LucideIcon = ({ name, size = 24, className, ...props }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {iconData.map(([tag, attrs], index) => React.createElement(tag, { ...attrs, key: index }))}
                </svg>
            );
        };

        const Settings = (p) => <LucideIcon name="Settings" {...p} />;
        const Volume2 = (p) => <LucideIcon name="Volume2" {...p} />;
        const VolumeX = (p) => <LucideIcon name="VolumeX" {...p} />;
        const Home = (p) => <LucideIcon name="Home" {...p} />;
        const Star = (p) => <LucideIcon name="Star" {...p} />;
        const ArrowRight = (p) => <LucideIcon name="ArrowRight" {...p} />;
        const RefreshCcw = (p) => <LucideIcon name="RefreshCcw" {...p} />;
        const CheckCircle = (p) => <LucideIcon name="CheckCircle" {...p} />;
        const XCircle = (p) => <LucideIcon name="XCircle" {...p} />;
        const Trophy = (p) => <LucideIcon name="Trophy" {...p} />;
        const Heart = (p) => <LucideIcon name="Heart" {...p} />;
        const Brain = (p) => <LucideIcon name="Brain" {...p} />;
        const Lightbulb = (p) => <LucideIcon name="Lightbulb" {...p} />;
        const Monitor = (p) => <LucideIcon name="Monitor" {...p} />;
        const Shuffle = (p) => <LucideIcon name="Shuffle" {...p} />;
        const Utensils = (p) => <LucideIcon name="Utensils" {...p} />;
        const Calculator = (p) => <LucideIcon name="Calculator" {...p} />;
        const Eraser = (p) => <LucideIcon name="Eraser" {...p} />;
        const BookOpen = (p) => <LucideIcon name="BookOpen" {...p} />;

        // --- 0. æ•¸æ“šåº«èˆ‡å¸¸æ•¸ ---
        
        const FOOD_TYPES = ['ğŸ¥š', 'ğŸ¡', 'ğŸ§‹', 'ğŸ', 'ğŸ¥Ÿ', 'ğŸœ']; 
        const ROWS = 6;
        const COLS = 6;
        
        const SUBJECTS = [
            { id: 'humanities', name: 'äººæ–‡ç§‘ï¼šé¦™æ¸¯ç¾é£Ÿ', icon: <Utensils size={32}/>, color: 'bg-orange-400' },
            { id: 'math', name: 'æ•¸å­¸ç§‘ï¼šå€‹ä½åŠ æ³•', icon: <Calculator size={32}/>, color: 'bg-blue-400' }
        ];

        // äººæ–‡ç§‘é¡Œåº«
        const FOOD_QUESTIONS = {
            beginner: [
                { id: 1, type: 'visual', q: "é€™æ˜¯ä¸€ç¨®å¾ˆå—æ­¡è¿çš„ä¸‹åˆèŒ¶é»å¿ƒï¼Œå¤–çš®é…¥é…¥çš„ï¼Œå®ƒæ˜¯ä»€éº¼ï¼Ÿ", img: "ğŸ¥š", options: [{t:"é›è›‹ä»”", c:false}, {t:"è›‹æ’»", c:true}, {t:"è è˜¿åŒ…", c:false}], hint: "å®ƒæ˜¯é»ƒè‰²çš„ï¼Œåœ“åœ“çš„ï¼Œåƒä¸€å€‹å°ç›¤å­ã€‚", fact: "è›‹æ’»æ˜¯é¦™æ¸¯æœ€å…·ä»£è¡¨æ€§çš„é»å¿ƒä¹‹ä¸€ï¼Œè¦è¶ç†±åƒå–”ï¼" },
                { id: 2, type: 'visual', q: "æˆ‘å€‘åœ¨è¡—é‚Šå°é£Ÿåº—å¸¸çœ‹åˆ°é€™å€‹ï¼Œé€šå¸¸ç”¨ç«¹ç±¤ä¸²èµ·ä¾†åƒï¼š", img: "ğŸ¡", options: [{t:"ç‡’è³£", c:false}, {t:"å’–å–±é­šè›‹", c:true}, {t:"ç‰›ä¸¸", c:false}], hint: "å®ƒæ˜¯é‡‘é»ƒè‰²çš„ï¼Œåœ“æ»¾æ»¾çš„ã€‚", fact: "å’–å–±é­šè›‹å¾®è¾£å½ˆç‰™ï¼Œæ˜¯æ”¾å­¸å¾Œçš„æœ€æ„›ï¼" },
                { id: 3, type: 'visual', q: "é£²èŒ¶çš„æ™‚å€™ï¼Œå¤–çš®é€æ˜ã€è£¡é¢æœ‰è¦çš„æ˜¯ä»€éº¼ï¼Ÿ", img: "ğŸ¥Ÿ", options: [{t:"å‰ç‡’åŒ…", c:false}, {t:"ç‡’è³£", c:false}, {t:"è¦é¤ƒ", c:true}], hint: "å®ƒçš„çš®è–„è–„çš„ï¼Œå¯ä»¥çœ‹åˆ°è£¡é¢ç´…ç´…çš„è¦ä»ã€‚", fact: "è¦é¤ƒè¢«ç¨±ç‚ºã€Œé»å¿ƒä¹‹ç‹ã€å–”ï¼" }
            ],
            intermediate: [
                { id: 4, type: 'logic', q: "è€ƒè€ƒä½ ï¼Œã€Œè è˜¿åŒ…ã€è£¡é¢æœ‰æ²’æœ‰ã€Œè è˜¿ã€é€™å€‹æ°´æœï¼Ÿ", img: "ğŸ", options: [{t:"æœ‰ï¼Œå¾ˆå¤š", c:false}, {t:"æ²’æœ‰", c:true}, {t:"æœ‰ï¼Œæ˜¯è è˜¿å‘³", c:false}], hint: "æƒ³ä¸€æƒ³ï¼Œå®ƒçš„åå­—æ˜¯å› ç‚ºæ¨£å­åƒï¼Œé‚„æ˜¯å› ç‚ºææ–™æœ‰ï¼Ÿ", fact: "è è˜¿åŒ…å› ç‚ºé…¥çš®è£‚é–‹åƒè è˜¿è€Œå¾—åï¼Œè£¡é¢æ²’æœ‰è è˜¿å–”ï¼" },
                { id: 5, type: 'logic', q: "è£½ä½œçµ²è¥ªå¥¶èŒ¶æ™‚ï¼ŒçœŸçš„æœƒç”¨ã€Œçµ²è¥ªã€ä¾†éæ¿¾å—ï¼Ÿ", img: "ğŸ§‹", options: [{t:"çœŸçš„", c:false}, {t:"å‡çš„ï¼Œæ˜¯æ£‰å¸ƒè¢‹", c:true}, {t:"ä¸çŸ¥é“", c:false}], hint: "é‚£æ˜¯ä¸€ç¨®é•·å¾—å¾ˆåƒçµ²è¥ªçš„å·¥å…·ã€‚", fact: "æ˜¯ç”¨ç™½è‰²çš„æ£‰å¸ƒè¢‹ï¼Œè¢«èŒ¶æŸ“æˆå’–å•¡è‰²å¾Œåƒçµ²è¥ªè€Œå·²ã€‚" }
            ],
            advanced: [
                { id: 6, type: 'context', q: "å’Œé•·è¼©åƒé£¯ï¼Œèœå‰›ä¸Šæ¡Œï¼Œæ‡‰è©²èª°å…ˆå‹•ç­·å­ï¼Ÿ", img: "ğŸ¥¢", options: [{t:"æˆ‘å…ˆåƒ", c:false}, {t:"è«‹é•·è¼©å…ˆåƒ", c:true}, {t:"èª°å¿«èª°å…ˆåƒ", c:false}], hint: "å­é †çš„å­©å­æœƒæ‡‚å¾—å°Šæ•¬é•·è¼©ã€‚", fact: "é•·å¹¼æœ‰åºï¼Œè®“çˆºçˆºå«²å«²å…ˆèµ·ç­·æ˜¯ç¦®è²Œçš„è¡¨ç¾ã€‚" },
                { id: 7, type: 'context', q: "åˆ¥äººå¹«ä½ å€’èŒ¶æ™‚ï¼Œç”¨æ‰‹æŒ‡è¼•æ•²æ¡Œé¢ä»£è¡¨ä»€éº¼ï¼Ÿ", img: "ğŸµ", options: [{t:"è¬è¬ (å©æ‰‹ç¦®)", c:true}, {t:"æˆ‘è¦æŠ•è¨´", c:false}, {t:"æ¯å­å¤ªç‡™", c:false}], hint: "é€™æ˜¯ä¸€å€‹å‚³é”æ„Ÿè¬çš„å‚³çµ±å‹•ä½œã€‚", fact: "é€™å«ã€Œå©æ‰‹ç¦®ã€ï¼Œæºè‡ªä¹¾éš†çš‡å¸çš„æ•…äº‹å‘¢ï¼" }
            ]
        };

        // æ•¸å­¸ç§‘é¡Œç›®ç”¢ç”Ÿå™¨
        const generateMathQuestion = (level) => {
            const n1 = Math.floor(Math.random() * 9) + 1; // 1-9
            const n2 = Math.floor(Math.random() * 9) + 1; // 1-9
            const ans = n1 + n2;
            const qText = `${n1} + ${n2} = ?`;

            // é«˜éšï¼šè¼¸å…¥é¡Œ
            if (level === 'advanced') {
                return {
                    id: `math-${Date.now()}`,
                    subject: 'math',
                    type: 'input', // æ¨™è¨˜ç‚ºè¼¸å…¥é¡Œ
                    q: qText,
                    img: 'ğŸ§®',
                    answer: ans.toString(),
                    hint: `è©¦è‘—ç”¨æ‰‹æŒ‡æ•¸æ•¸çœ‹ï¼š${n1} åŠ ä¸Š ${n2}`,
                    fact: `å¤ªæ£’äº†ï¼${n1} åŠ  ${n2} ç­‰æ–¼ ${ans}ã€‚æ•¸å­¸çœŸæœ‰è¶£ï¼`
                };
            } 
            // åˆéš/ä¸­éšï¼šé¸æ“‡é¡Œ
            else {
                let opts = [ans];
                while(opts.length < 3) {
                    // ç”Ÿæˆå¹²æ“¾é … (ç­”æ¡ˆ +/- 1~3)
                    let r = ans + Math.floor(Math.random() * 7) - 3; 
                    if (r > 0 && !opts.includes(r)) opts.push(r);
                }
                // æ‰“äº‚é¸é …
                const options = opts.sort(() => Math.random() - 0.5).map(v => ({
                    t: v.toString(),
                    c: v === ans
                }));

                return {
                    id: `math-${Date.now()}`,
                    subject: 'math',
                    type: 'choice',
                    q: qText,
                    img: 'ğŸ”¢',
                    options: options,
                    hint: `æŠŠ ${n1} å’Œ ${n2} åˆèµ·ä¾†æ•¸ä¸€æ•¸ã€‚`,
                    fact: `ç­”å°äº†ï¼${n1} + ${n2} = ${ans}`
                };
            }
        };

        // --- 1. å·¥å…·å‡½å¼ (Grid Logic) ---

        const createItem = (type) => ({ id: Math.random().toString(36).substr(2, 9), type });

        const generateGrid = () => {
            const grid = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    let type;
                    do {
                        type = FOOD_TYPES[Math.floor(Math.random() * FOOD_TYPES.length)];
                    } while (
                        (c >= 2 && grid[r][c-1].type === type && grid[r][c-2].type === type) ||
                        (r >= 2 && grid[r-1][c].type === type && grid[r-2][c].type === type)
                    );
                    grid[r][c] = createItem(type);
                }
            }
            return grid;
        };

        const findMatches = (grid) => {
            const matches = new Set();
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS - 2; c++) {
                    const t1 = grid[r][c], t2 = grid[r][c+1], t3 = grid[r][c+2];
                    if (t1 && t2 && t3 && t1.type === t2.type && t2.type === t3.type) {
                        matches.add(`${r},${c}`); matches.add(`${r},${c+1}`); matches.add(`${r},${c+2}`);
                    }
                }
            }
            for (let c = 0; c < COLS; c++) {
                for (let r = 0; r < ROWS - 2; r++) {
                    const t1 = grid[r][c], t2 = grid[r+1][c], t3 = grid[r+2][c];
                    if (t1 && t2 && t3 && t1.type === t2.type && t2.type === t3.type) {
                        matches.add(`${r},${c}`); matches.add(`${r+1},${c}`); matches.add(`${r+2},${c}`);
                    }
                }
            }
            return matches;
        };

        const speak = (text, rate = 1.0, enabled = true) => {
            if (!enabled || !window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-HK';
            utterance.rate = rate;
            const voices = window.speechSynthesis.getVoices();
            const hkVoice = voices.find(v => v.lang === 'zh-HK');
            if (hkVoice) utterance.voice = hkVoice;
            window.speechSynthesis.speak(utterance);
        };

        // --- 2. çµ„ä»¶ (Components) ---

        const Preferences = ({ config, setConfig, isOpen, setIsOpen }) => {
            return (
                <div className="fixed top-4 right-4 z-50">
                    <button onClick={() => setIsOpen(!isOpen)} className="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-2xl shadow-lg transition-all transform hover:scale-105">
                        {isOpen ? <XCircle size={24} /> : <Settings size={24} />}
                    </button>
                    <AnimatePresence>
                        {isOpen && (
                            <motion.div initial={{ x: 300, opacity: 0 }} animate={{ x: 0, opacity: 1 }} exit={{ x: 300, opacity: 0 }} className="absolute top-16 right-0 w-72 glass-panel rounded-3xl p-6 shadow-2xl">
                                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Settings size={20} /> åå¥½è¨­å®š</h3>
                                <div className="mb-6">
                                    <label className="block text-gray-600 mb-2 font-medium">å­—é«”å¤§å°</label>
                                    <input type="range" min="14" max="32" step="2" value={config.fontSize} onChange={(e) => setConfig({...config, fontSize: parseInt(e.target.value)})} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"/>
                                    <div className="flex justify-between text-xs text-gray-400 mt-1"><span>å°</span><span>ä¸­</span><span>å¤§</span></div>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-gray-600 mb-2 font-medium">èªªè©±é€Ÿåº¦</label>
                                    <input type="range" min="0.5" max="1.0" step="0.1" value={config.speechRate} onChange={(e) => setConfig({...config, speechRate: parseFloat(e.target.value)})} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-green-500"/>
                                    <div className="flex justify-between text-2xl mt-1"><span>ğŸ¢</span><span>ğŸ‡</span></div>
                                </div>
                                <div className="flex items-center justify-between">
                                    <span className="text-gray-600 font-medium">èªéŸ³æœ—è®€</span>
                                    <button onClick={() => setConfig({...config, soundEnabled: !config.soundEnabled})} className={`p-2 rounded-full ${config.soundEnabled ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                        {config.soundEnabled ? <Volume2 size={24}/> : <VolumeX size={24}/>}
                                    </button>
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const QuizModal = ({ question, config, onClose, onAnswer }) => {
            const [answered, setAnswered] = useState(false);
            const [attempts, setAttempts] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [inputValue, setInputValue] = useState(""); // ç”¨æ–¼è¼¸å…¥é¡Œ
            const [showHint, setShowHint] = useState(false);

            useEffect(() => {
                speak(question.q, config.speechRate, config.soundEnabled);
            }, [question]);

            // é¸æ“‡é¡Œè™•ç†
            const handleOptionClick = (option, index) => {
                if (answered) return;
                setSelectedOption(index);
                if (option.c) {
                    handleCorrect();
                } else {
                    handleWrong();
                }
            };

            // è¼¸å…¥é¡Œè™•ç† (æ•¸å­—éµç›¤)
            const handleNumpadInput = (val) => {
                if (answered) return;
                if (val === 'del') {
                    setInputValue(prev => prev.slice(0, -1));
                } else if (val === 'ok') {
                    if (inputValue === question.answer) {
                        handleCorrect();
                    } else {
                        handleWrong();
                        setInputValue(""); // æ¸…ç©ºé‡è©¦
                    }
                } else {
                    if (inputValue.length < 3) setInputValue(prev => prev + val);
                }
            };

            const handleCorrect = () => {
                speak("ç­”å°äº†ï¼" + question.fact, config.speechRate, config.soundEnabled);
                setAnswered(true);
                setTimeout(() => {
                    onAnswer(true, attempts);
                    onClose();
                }, 3000);
            };

            const handleWrong = () => {
                setAttempts(prev => prev + 1);
                speak("å†è©¦ä¸€æ¬¡ï¼ŒåŠ æ²¹ï¼", config.speechRate, config.soundEnabled);
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <motion.div initial={{ scale: 0.8, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="bg-white rounded-[30px] p-6 max-w-md w-full shadow-2xl border-4 border-blue-200 flex flex-col items-center">
                        <div className="text-6xl mb-4 p-4 bg-blue-50 rounded-full">{question.img}</div>
                        <h2 className="text-xl font-bold text-gray-800 text-center mb-6">{question.q} <button onClick={() => speak(question.q, config.speechRate, true)} className="inline-block ml-2 text-blue-500 align-middle"><Volume2 size={24} /></button></h2>
                        
                        {/* å€åˆ†ï¼šè¼¸å…¥é¡Œ vs é¸æ“‡é¡Œ */}
                        {question.type === 'input' ? (
                            <div className="w-full mb-4">
                                {/* é¡¯ç¤ºè¼¸å…¥æ¡† */}
                                <div className="w-full p-4 bg-gray-100 rounded-xl text-center text-3xl font-bold tracking-widest mb-4 border-2 border-blue-200 h-16 flex items-center justify-center">
                                    {inputValue || <span className="text-gray-300">?</span>}
                                </div>
                                {/* è™›æ“¬æ•¸å­—éµç›¤ */}
                                {!answered && (
                                    <div className="grid grid-cols-3 gap-2">
                                        {[1,2,3,4,5,6,7,8,9].map(n => (
                                            <button key={n} onClick={() => handleNumpadInput(n.toString())} className="p-3 bg-white border-b-4 border-gray-200 rounded-lg font-bold text-xl active:scale-95 hover:bg-gray-50">{n}</button>
                                        ))}
                                        <button onClick={() => handleNumpadInput('del')} className="p-3 bg-red-100 text-red-500 border-b-4 border-red-200 rounded-lg font-bold active:scale-95 flex justify-center items-center"><Eraser size={20}/></button>
                                        <button onClick={() => handleNumpadInput('0')} className="p-3 bg-white border-b-4 border-gray-200 rounded-lg font-bold text-xl active:scale-95 hover:bg-gray-50">0</button>
                                        <button onClick={() => handleNumpadInput('ok')} className="p-3 bg-green-500 text-white border-b-4 border-green-600 rounded-lg font-bold text-xl active:scale-95 shadow-md">OK</button>
                                    </div>
                                )}
                                {answered && <div className="text-center text-green-600 font-bold text-2xl mt-4 animate-bounce">âœ… æ­£ç¢ºç­”æ¡ˆï¼š{question.answer}</div>}
                            </div>
                        ) : (
                            // é¸æ“‡é¡Œ UI
                            <div className="w-full space-y-3 mb-4">
                                {question.options.map((opt, idx) => (
                                    <button key={idx} onClick={() => handleOptionClick(opt, idx)} disabled={answered} className={`w-full p-4 rounded-xl text-lg font-bold transition-all flex items-center justify-between border-2 ${answered && opt.c ? 'bg-green-100 border-green-400 text-green-800' : ''} ${selectedOption === idx && !opt.c && !answered ? 'bg-red-50 border-red-200 text-red-800' : 'bg-gray-50 border-gray-100 hover:bg-blue-50'}`}>
                                        <span>{opt.t}</span>
                                        {answered && opt.c && <CheckCircle className="text-green-500" />}
                                        {selectedOption === idx && !opt.c && !answered && <XCircle className="text-red-400" />}
                                    </button>
                                ))}
                            </div>
                        )}

                        {answered ? (
                            <motion.div initial={{y:10, opacity:0}} animate={{y:0, opacity:1}} className="bg-green-50 p-4 rounded-xl w-full text-green-800 text-sm"><span className="font-bold">ğŸ’¡ çŸ¥è­˜å°ç™¾ç§‘ï¼š</span> {question.fact}</motion.div>
                        ) : (
                            <div className="w-full flex justify-between items-center mt-2">
                                <button onClick={() => {setShowHint(true); setAttempts(prev => prev+1);}} className="text-gray-400 text-sm flex items-center gap-1 hover:text-orange-500"><Lightbulb size={16} /> æˆ‘éœ€è¦æç¤º</button>
                                {showHint && <span className="text-orange-500 text-sm animate-pulse">{question.hint}</span>}
                            </div>
                        )}
                    </motion.div>
                </div>
            );
        };

        // --- 3. æ ¸å¿ƒéŠæˆ²å€ (GameArea) ---
        
        const GameArea = ({ level, subject, config, onGameOver, updateScore }) => {
            const [grid, setGrid] = useState([]);
            const [selected, setSelected] = useState(null); 
            const [isProcessing, setIsProcessing] = useState(false);
            const [movesLeft, setMovesLeft] = useState(15);
            const [quizData, setQuizData] = useState(null); 
            
            useEffect(() => {
                setGrid(generateGrid());
            }, []);

            useEffect(() => {
                if (!grid.length) return;
                if (quizData) return;

                const matches = findMatches(grid);
                
                if (matches.size > 0) {
                    setIsProcessing(true);
                    setTimeout(() => {
                        const newGrid = grid.map(row => [...row]);
                        const colsToUpdate = new Set();
                        
                        matches.forEach(key => {
                            const [r, c] = key.split(',').map(Number);
                            if(newGrid[r][c]) {
                                newGrid[r][c] = null;
                                colsToUpdate.add(c);
                            }
                        });

                        for (let c = 0; c < COLS; c++) {
                            let emptyCount = 0;
                            for (let r = ROWS - 1; r >= 0; r--) {
                                if (newGrid[r][c] === null) {
                                    emptyCount++;
                                } else if (emptyCount > 0) {
                                    newGrid[r + emptyCount][c] = newGrid[r][c];
                                    newGrid[r][c] = null;
                                }
                            }
                            for (let r = 0; r < emptyCount; r++) {
                                newGrid[r][c] = createItem(FOOD_TYPES[Math.floor(Math.random() * FOOD_TYPES.length)]);
                            }
                        }

                        setGrid(newGrid);
                    }, 600); 
                } else {
                    setIsProcessing(false);
                    if (movesLeft <= 0 && !isProcessing) {
                        onGameOver();
                    }
                }
            }, [grid, quizData]); 

            const handleSwap = async (r1, c1, r2, c2) => {
                setIsProcessing(true);
                const tempGrid = grid.map(row => [...row]);
                const temp = tempGrid[r1][c1];
                tempGrid[r1][c1] = tempGrid[r2][c2];
                tempGrid[r2][c2] = temp;
                setGrid(tempGrid);

                await new Promise(res => setTimeout(res, 300));
                const matches = findMatches(tempGrid);

                if (matches.size > 0) {
                    setMovesLeft(prev => prev - 1);
                    // è§¸ç™¼å•ç­”ï¼šæ ¹æ“šç§‘ç›®å’Œé›£åº¦
                    let q;
                    if (subject === 'math') {
                        q = generateMathQuestion(level);
                    } else {
                        // äººæ–‡ç§‘ (ç¾é£Ÿ)
                        const pool = FOOD_QUESTIONS[level] || FOOD_QUESTIONS['beginner'];
                        q = pool[Math.floor(Math.random() * pool.length)];
                    }
                    setQuizData(q);
                    
                } else {
                    const revertGrid = tempGrid.map(row => [...row]);
                    const temp2 = revertGrid[r1][c1];
                    revertGrid[r1][c1] = revertGrid[r2][c2];
                    revertGrid[r2][c2] = temp2;
                    setGrid(revertGrid); 
                    setIsProcessing(false);
                    speak("å“å‘€ï¼Œé€™è£¡ä¸èƒ½æ¶ˆé™¤å–”", config.speechRate, config.soundEnabled);
                }
                setSelected(null);
            };

            const handleCellClick = (r, c) => {
                if (isProcessing || quizData) return;
                if (!selected) {
                    setSelected({r, c});
                    speak(grid[r][c].type, config.speechRate, config.soundEnabled);
                } else {
                    const isAdjacent = Math.abs(selected.r - r) + Math.abs(selected.c - c) === 1;
                    if (isAdjacent) {
                        handleSwap(selected.r, selected.c, r, c);
                    } else {
                        if (selected.r === r && selected.c === c) {
                            setSelected(null);
                        } else {
                            setSelected({r, c});
                            speak(grid[r][c].type, config.speechRate, config.soundEnabled);
                        }
                    }
                }
            };

            return (
                <div className="flex flex-col items-center w-full h-full relative">
                    <div className="flex justify-between w-full max-w-md mb-4 px-4 z-10">
                        <div className="bg-white/90 rounded-full px-4 py-2 font-bold text-orange-600 shadow-sm border border-orange-100 flex items-center gap-2">
                            <span>ğŸ‘£ æ­¥æ•¸: {movesLeft}</span>
                        </div>
                        <button onClick={() => setGrid(generateGrid())} className="bg-white/90 p-2 rounded-full text-blue-500 shadow-sm"><Shuffle size={20}/></button>
                    </div>

                    <div className="grid grid-cols-6 gap-1 sm:gap-2 p-2 sm:p-3 bg-orange-100/60 rounded-3xl backdrop-blur-sm border-4 border-orange-200 select-none touch-none"
                        style={{ width: 'min(95vw, 500px)', height: 'min(95vw, 500px)' }}>
                        {grid.map((row, r) => (
                            row.map((cell, c) => (
                                <motion.div
                                    key={cell ? cell.id : `empty-${r}-${c}`}
                                    layout
                                    transition={{ type: "spring", stiffness: 300, damping: 25 }}
                                    onClick={() => handleCellClick(r, c)}
                                    className={`
                                        w-full h-full flex items-center justify-center text-3xl sm:text-4xl rounded-xl sm:rounded-2xl shadow-sm border-b-4 cursor-pointer relative
                                        ${selected?.r === r && selected?.c === c 
                                            ? 'bg-yellow-200 border-yellow-400 z-10 ring-4 ring-yellow-300 scale-105' 
                                            : 'bg-white border-gray-200 hover:bg-gray-50'}
                                    `}>
                                    {cell ? cell.type : ''}
                                </motion.div>
                            ))
                        ))}
                    </div>

                    <AnimatePresence>
                        {quizData && (
                            <QuizModal 
                                question={quizData} 
                                config={config}
                                onClose={() => setQuizData(null)}
                                onAnswer={(isCorrect, attempts) => updateScore(isCorrect, attempts)}
                            />
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const ReportScreen = ({ score, effort, onRestart, onHome }) => {
            const totalScore = score + effort;
            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex flex-col items-center justify-center min-h-screen p-6">
                    <div className="bg-white/90 p-8 rounded-[40px] shadow-2xl max-w-md w-full text-center border-4 border-yellow-200">
                        <Trophy size={64} className="mx-auto text-yellow-500 mb-4" />
                        <h2 className="text-3xl font-black text-gray-800 mb-2">æŒ‘æˆ°å®Œæˆï¼</h2>
                        <div className="space-y-4 mb-8">
                            <div className="bg-blue-50 p-4 rounded-2xl flex justify-between items-center">
                                <span className="font-bold text-blue-800 flex items-center gap-2"><Brain size={20}/> çŸ¥è­˜å¾—åˆ†</span>
                                <span className="text-2xl font-black text-blue-600">{score}</span>
                            </div>
                            <div className="bg-orange-50 p-4 rounded-2xl flex justify-between items-center">
                                <span className="font-bold text-orange-800 flex items-center gap-2"><Heart size={20}/> åŠªåŠ›å˜—è©¦</span>
                                <span className="text-2xl font-black text-orange-600">{effort}</span>
                            </div>
                            <div className="border-t-2 border-dashed border-gray-300 pt-4 mt-2">
                                <div className="flex justify-between items-end"><span className="text-gray-600 font-bold text-lg">ç¸½æˆå°±åˆ†</span><span className="text-4xl font-black text-purple-600">{totalScore}</span></div>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={onHome} className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-xl flex justify-center items-center gap-2"><Home size={20}/> ä¸»é¸å–®</button>
                            <button onClick={onRestart} className="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2"><RefreshCcw size={20}/> å†ç©ä¸€æ¬¡</button>
                        </div>
                    </div>
                </motion.div>
            );
        };

        const WelcomeScreen = ({ onStart, userName, setUserName }) => {
            const [step, setStep] = useState(1); // 1: Name, 2: Subject, 3: Level
            const [selectedSubject, setSelectedSubject] = useState(null);

            const handleNameSubmit = () => {
                if(userName.trim()) setStep(2);
                else alert("è«‹å…ˆè¼¸å…¥åå­—å–”ï¼");
            };

            const handleSubjectSelect = (subId) => {
                setSelectedSubject(subId);
                setStep(3);
            };

            return (
                <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} className="flex flex-col items-center justify-center min-h-screen p-6 text-center">
                    <div className="bg-white/60 p-8 rounded-[40px] shadow-xl backdrop-blur-sm max-w-md w-full border-4 border-white relative">
                        {step > 1 && (
                            <button onClick={() => setStep(step-1)} className="absolute top-4 left-4 p-2 bg-white rounded-full shadow-sm text-gray-500">
                                <ArrowRight className="rotate-180" size={20}/>
                            </button>
                        )}

                        <div className="mb-6 animate-bounce text-6xl">ğŸ“</div>
                        <h1 className="text-4xl font-black text-orange-500 mb-2 tracking-tight">é¦™æ¸¯å°å­¸å ‚</h1>
                        <p className="text-gray-600 mb-8 font-medium">å¿«æ¨‚å­¸ç¿’ï¼Œå¤©å¤©å‘ä¸Šï¼</p>
                        
                        {step === 1 && (
                            <div className="space-y-4">
                                <input type="text" placeholder="è«‹è¼¸å…¥ä½ çš„åå­—" value={userName} onChange={(e) => setUserName(e.target.value)} className="w-full p-4 rounded-2xl border-2 border-orange-200 focus:border-orange-400 focus:outline-none text-center text-xl bg-white/80"/>
                                <button onClick={handleNameSubmit} className="w-full bg-orange-400 hover:bg-orange-500 text-white font-bold py-4 rounded-2xl shadow-md transition transform hover:-translate-y-1 text-xl">
                                    ä¸‹ä¸€æ­¥ â¡ï¸
                                </button>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="space-y-4">
                                <h3 className="text-xl font-bold text-gray-700 mb-4">ä½ æƒ³å­¸ç¿’å“ªä¸€ç§‘ï¼Ÿ</h3>
                                {SUBJECTS.map(sub => (
                                    <button key={sub.id} onClick={() => handleSubjectSelect(sub.id)} className={`w-full ${sub.color} hover:brightness-110 text-white font-bold py-6 rounded-2xl shadow-md transition transform hover:-translate-y-1 flex items-center justify-center gap-4 text-xl`}>
                                        {sub.icon} {sub.name}
                                    </button>
                                ))}
                            </div>
                        )}

                        {step === 3 && (
                            <div className="space-y-4">
                                <h3 className="text-xl font-bold text-gray-700 mb-4">é¸æ“‡æŒ‘æˆ°é›£åº¦</h3>
                                <button onClick={() => onStart(selectedSubject, 'beginner')} className="w-full bg-green-400 hover:bg-green-500 text-white font-bold py-4 rounded-2xl shadow-md transition transform hover:-translate-y-1">
                                    ğŸŸ¢ åˆéš (é¸æ“‡é¡Œ)
                                </button>
                                {/* æ•¸å­¸ç§‘çš„ä¸­éšæˆ‘å€‘æš«æ™‚éš±è—æˆ–è¨­ç‚ºèˆ‡åˆéšç›¸åŒé‚è¼¯ä½†æ•¸å­—ä¸åŒï¼Œé€™è£¡ç‚ºäº†ç°¡åŒ–ä¾ä½¿ç”¨è€…éœ€æ±‚åªåˆ†é¸æ“‡èˆ‡è¼¸å…¥ */}
                                {selectedSubject === 'humanities' && (
                                    <button onClick={() => onStart(selectedSubject, 'intermediate')} className="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-4 rounded-2xl shadow-md transition transform hover:-translate-y-1">
                                        ğŸŸ¡ ä¸­éš (å‹•è…¦ç­‹)
                                    </button>
                                )}
                                <button onClick={() => onStart(selectedSubject, 'advanced')} className="w-full bg-red-400 hover:bg-red-500 text-white font-bold py-4 rounded-2xl shadow-md transition transform hover:-translate-y-1">
                                    ğŸ”´ é«˜éš ({selectedSubject === 'math' ? 'è¼¸å…¥ç­”æ¡ˆ' : 'ç”Ÿæ´»ç¦®å„€'})
                                </button>
                            </div>
                        )}
                    </div>
                </motion.div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('welcome');
            const [userName, setUserName] = useState('');
            const [level, setLevel] = useState('beginner');
            const [subject, setSubject] = useState('humanities');
            const [score, setScore] = useState(0);
            const [effort, setEffort] = useState(0);
            const [isPrefOpen, setIsPrefOpen] = useState(false);
            const [config, setConfig] = useState({ fontSize: 18, speechRate: 0.8, soundEnabled: true });

            useEffect(() => { document.documentElement.style.fontSize = `${config.fontSize}px`; }, [config.fontSize]);

            const startGame = (sub, lvl) => {
                setSubject(sub);
                setLevel(lvl); 
                setScore(0); setEffort(0); setGameState('playing');
                const subName = sub === 'math' ? 'æ•¸å­¸èª²' : 'å¸¸è­˜èª²';
                speak(`ä½ å¥½${userName}ï¼Œæ­¡è¿ä¾†åˆ°${subName}ï¼Œæˆ‘å€‘é–‹å§‹éŠæˆ²å§ï¼`, config.speechRate, config.soundEnabled);
            };

            const handleScoreUpdate = (isCorrect, attempts) => {
                if(isCorrect) { setScore(p => p + 10); setEffort(p => p + attempts); }
            };

            return (
                <div className="min-h-screen relative overflow-hidden select-none">
                    <div className="fixed top-0 left-0 w-full h-full -z-10 opacity-30 pointer-events-none">
                        <div className="absolute top-10 left-10 w-32 h-32 bg-yellow-300 rounded-full blur-3xl mix-blend-multiply animate-pulse"></div>
                        <div className="absolute bottom-10 right-10 w-48 h-48 bg-pink-300 rounded-full blur-3xl mix-blend-multiply animate-pulse" style={{animationDelay: '1s'}}></div>
                    </div>
                    {gameState === 'playing' && (
                        <nav className="fixed top-0 w-full p-4 flex justify-between items-center z-40 bg-white/50 backdrop-blur-md">
                            <button onClick={() => setGameState('welcome')} className="bg-white p-2 rounded-xl shadow-sm text-gray-600 flex items-center gap-2 text-sm font-bold border border-gray-200"><ArrowRight className="rotate-180" size={18} /> è¿”å›</button>
                            <div className="flex items-center gap-4"><div className="flex flex-col items-end"><span className="text-xs text-gray-500 font-bold">{userName}</span><span className="text-lg font-black text-orange-500 flex items-center gap-1"><Star size={18} fill="currentColor"/> {score + effort}</span></div></div>
                        </nav>
                    )}
                    <Preferences config={config} setConfig={setConfig} isOpen={isPrefOpen} setIsOpen={setIsPrefOpen} />
                    <main className="pt-16 pb-20 w-full h-full flex flex-col items-center">
                        {gameState === 'welcome' && <WelcomeScreen onStart={startGame} userName={userName} setUserName={setUserName} />}
                        {gameState === 'playing' && <GameArea level={level} subject={subject} config={config} updateScore={handleScoreUpdate} onGameOver={() => setGameState('report')} />}
                        {gameState === 'report' && <ReportScreen score={score} effort={effort} onRestart={() => startGame(subject, level)} onHome={() => setGameState('welcome')} />}
                    </main>
                    <footer className="fixed bottom-0 w-full text-center py-2 text-gray-400 text-[10px] bg-white/30 backdrop-blur-sm z-30">Â©2025 WMC - å°ˆç‚ºå­¸ç¿’è¨­è¨ˆ</footer>
                    <div className="fixed bottom-6 right-6 z-50">
                        <div className="holographic-btn px-4 py-2 rounded-full flex items-center gap-2 text-white font-bold text-xs tracking-wider cursor-pointer transform hover:scale-105 transition-all"><Monitor size={14} /><span>WMC ç¨‹æ£¨å½¥ è¨­è¨ˆ</span></div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
